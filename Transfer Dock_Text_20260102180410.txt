from flask import Flask, send_file, Response
from telegram import Update
from telegram.ext import Application, CommandHandler, MessageHandler, filters, ContextTypes
import os
from threading import Thread
import io

app = Flask(__name__)

# Bot configuration
BOT_TOKEN = "YOUR_BOT_TOKEN_HERE"
WEBHOOK_URL = "YOUR_RENDER_URL_HERE"  # e.g., https://your-app.onrender.com

# In-memory storage (files stored temporarily)
file_storage = {}

@app.route('/')
def home():
    return "Bot is running!"

@app.route('/stream/<file_id>')
def stream_file(file_id):
    """Stream file directly"""
    if file_id not in file_storage:
        return "File not found", 404
    
    file_data = file_storage[file_id]
    return send_file(
        io.BytesIO(file_data['content']),
        mimetype=file_data['mime_type'],
        as_attachment=False,
        download_name=file_data['filename']
    )

# Telegram Bot Handlers
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text(
        "üìÅ File to Stream Link Bot\n\n"
        "Mujhe koi bhi file send karo (video, audio, document)\n"
        "Main uska streamable link de dunga! üé¨\n\n"
        "Bas file bhejo aur link mil jayega!"
    )

async def handle_file(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Handle all types of files"""
    message = update.message
    file = None
    filename = None
    mime_type = "application/octet-stream"
    
    # Check file type
    if message.document:
        file = message.document
        filename = file.file_name
        mime_type = file.mime_type or mime_type
    elif message.video:
        file = message.video
        filename = f"video_{file.file_id}.mp4"
        mime_type = file.mime_type or "video/mp4"
    elif message.audio:
        file = message.audio
        filename = file.file_name or f"audio_{file.file_id}.mp3"
        mime_type = file.mime_type or "audio/mpeg"
    elif message.voice:
        file = message.voice
        filename = f"voice_{file.file_id}.ogg"
        mime_type = "audio/ogg"
    
    if not file:
        await message.reply_text("‚ùå Please send a valid file!")
        return
    
    # Send processing message
    status_msg = await message.reply_text("‚è≥ Processing your file...")
    
    try:
        # Download file
        telegram_file = await context.bot.get_file(file.file_id)
        file_bytes = await telegram_file.download_as_bytearray()
        
        # Store file in memory
        file_id = file.file_id
        file_storage[file_id] = {
            'content': bytes(file_bytes),
            'filename': filename,
            'mime_type': mime_type
        }
        
        # Generate streaming link
        stream_link = f"{WEBHOOK_URL}/stream/{file_id}"
        
        # Create embed code for videos
        embed_code = ""
        if mime_type.startswith('video/'):
            embed_code = f'\n\nüì∫ <b>Embed Code:</b>\n<code>&lt;video controls width="100%"&gt;\n  &lt;source src="{stream_link}" type="{mime_type}"&gt;\n&lt;/video&gt;</code>'
        elif mime_type.startswith('audio/'):
            embed_code = f'\n\nüéµ <b>Embed Code:</b>\n<code>&lt;audio controls&gt;\n  &lt;source src="{stream_link}" type="{mime_type}"&gt;\n&lt;/audio&gt;</code>'
        
        await status_msg.edit_text(
            f"‚úÖ <b>File Ready!</b>\n\n"
            f"üìÑ <b>Filename:</b> {filename}\n"
            f"üîó <b>Stream Link:</b>\n<code>{stream_link}</code>\n"
            f"{embed_code}\n\n"
            f"üí° Is link ko kisi bhi website par use kar sakte ho!",
            parse_mode='HTML'
        )
        
    except Exception as e:
        await status_msg.edit_text(f"‚ùå Error: {str(e)}")

def run_flask():
    """Run Flask server"""
    port = int(os.environ.get("PORT", 10000))
    app.run(host='0.0.0.0', port=port)

async def post_init(application: Application):
    """Set webhook after bot initialization"""
    await application.bot.set_webhook(url=f"{WEBHOOK_URL}/webhook")

def main():
    # Start Flask in a separate thread
    flask_thread = Thread(target=run_flask)
    flask_thread.daemon = True
    flask_thread.start()
    
    # Create bot application
    application = Application.builder().token(BOT_TOKEN).post_init(post_init).build()
    
    # Add handlers
    application.add_handler(CommandHandler("start", start))
    application.add_handler(MessageHandler(
        filters.Document.ALL | filters.VIDEO | filters.AUDIO | filters.VOICE, 
        handle_file
    ))
    
    # Start bot with webhook
    application.run_webhook(
        listen="0.0.0.0",
        port=int(os.environ.get("PORT", 10000)),
        url_path="/webhook",
        webhook_url=f"{WEBHOOK_URL}/webhook"
    )

if __name__ == '__main__':
    main()